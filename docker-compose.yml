# Docker Compose for Holocron Analytics local development
# Run: docker compose up --build
#
# Services:
#   - sqlserver: SQL Server Developer Edition (persisted)
#   - initdb: Creates database if missing (runs once, then exits)
#   - seed: Loads seed data into tables (runs once, then exits)
#
# After startup, SQL Server remains running for interactive use.
# Connect with SSMS/Azure Data Studio: localhost,1433 | sa | <your password>

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: holocron-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Developer
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${MSSQL_SA_PASSWORD}" -C -Q "SELECT 1" -b
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  initdb:
    image: mcr.microsoft.com/mssql-tools:latest
    container_name: holocron-initdb
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - DATABASE_NAME=${MSSQL_DATABASE:-Holocron}
    volumes:
      - ./docker/init-db.sql:/init-db.sql:ro
      - ./src/db/ddl:/ddl:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo "=== Creating database if not exists ==="
        /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P "$${MSSQL_SA_PASSWORD}" -C \
          -v DATABASE_NAME="$${DATABASE_NAME}" \
          -i /init-db.sql

        echo "=== Running DDL scripts ==="
        # Run dimension scripts
        for script in /ddl/01_dimensions/*.sql; do
          echo "Running $${script}..."
          /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P "$${MSSQL_SA_PASSWORD}" -C \
            -d "$${DATABASE_NAME}" -i "$${script}" || echo "Warning: $${script} may have failed"
        done
        
        # Run fact scripts if they exist
        if [ -d "/ddl/02_facts" ]; then
          for script in /ddl/02_facts/*.sql; do
            if [ -f "$${script}" ]; then
              echo "Running $${script}..."
              /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P "$${MSSQL_SA_PASSWORD}" -C \
                -d "$${DATABASE_NAME}" -i "$${script}" || echo "Warning: $${script} may have failed"
            fi
          done
        fi
        
        # Run bridge scripts if they exist
        if [ -d "/ddl/03_bridges" ]; then
          for script in /ddl/03_bridges/*.sql; do
            if [ -f "$${script}" ]; then
              echo "Running $${script}..."
              /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P "$${MSSQL_SA_PASSWORD}" -C \
                -d "$${DATABASE_NAME}" -i "$${script}" || echo "Warning: $${script} may have failed"
            fi
          done
        fi
        
        echo "=== Database initialization complete ==="

  seed:
    build:
      context: .
      dockerfile: docker/Dockerfile.seed
    container_name: holocron-seed
    depends_on:
      initdb:
        condition: service_completed_successfully
    environment:
      - SEED_SQLSERVER_HOST=sqlserver
      - SEED_SQLSERVER_DATABASE=${MSSQL_DATABASE:-Holocron}
      - SEED_SQLSERVER_USER=sa
      - SEED_SQLSERVER_PASSWORD=${MSSQL_SA_PASSWORD}
      - SEED_SQLSERVER_PORT=1433
      - SEED_SQLSERVER_DRIVER=ODBC Driver 18 for SQL Server
      - SEED_SKIP=${SEED_SKIP:-false}
    command: >
      /bin/bash -c '
        if [ "$${SEED_SKIP}" = "true" ]; then
          echo "SEED_SKIP=true, skipping seed loader"
          exit 0
        fi
        python src/ingest/seed_loader.py --all --verbose --no-file-log
      '
    volumes:
      # Mount src read-only for development (allows code changes without rebuild)
      - ./src:/app/src:ro

volumes:
  mssql_data:
    driver: local
