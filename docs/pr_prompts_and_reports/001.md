# PR #1: Add JSON seed-data framework for SQL Server dimensional model

## Header

| Field | Value |
|---|---|
| **PR Number** | 1 |
| **Title** | Add JSON seed-data framework for SQL Server dimensional model |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/1 |
| **State** | merged |
| **Created** | 2026-01-17T04:36:19Z |
| **Updated** | 2026-01-17T04:54:03Z |
| **Merged** | 2026-01-17T04:54:03Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/add-json-seed-data-framework` |
| **Merge commit SHA** | `583a3ccf6b88c9974ca257706c61cc9ba268a8a4` |

---

## PR Body

Framework to TRUNCATE + RESEED SQL Server dims/facts/bridges with deterministic JSON seed data. Supports FK-aware load ordering, auto-computed RowHash, and UUIDv5 generation for missing GUIDs.

### Folder Structure
- `src/db/seeds/data/` — 21 seed JSON files (Star Wars synthetic data)
- `src/db/seeds/README.md` — Runbook, format spec, load order
- `src/db/seeds/logs/` — Runtime logs (gitignored)

### Seed JSON Format
```json
{
  "seedVersion": "0.1.0",
  "generatedUtc": "2026-01-16T00:00:00Z",
  "target": {
    "schema": "dbo",
    "table": "DimFranchise",
    "naturalKey": ["UniverseCode"],
    "loadBehavior": "truncate-insert"
  },
  "options": {
    "allowIdentityInsert": false,
    "defaults": { "IsActive": true, "IsLatest": true }
  },
  "rows": [{ "FranchiseGuid": "...", "Name": "Star Wars", ... }]
}
```

### Python Loader (`src/ingest/`)
- `seed_loader.py` — CLI: `--all`, `--tables`, `--dry-run`, `--verbose`
- `seeds/seed_io.py` — JSON parsing, UUIDv5 generation, SHA-256 RowHash
- `seeds/db_introspection.py` — Column discovery via INFORMATION_SCHEMA
- `seeds/db_loader.py` — TRUNCATE/INSERT with FK constraint handling

### Load Order
Static ordering for 21 tables respecting FK dependencies. TRUNCATE in reverse order, INSERT in forward order. Falls back to DELETE with constraint toggle if TRUNCATE fails.

### Configuration
```bash
# .env
SEED_SQLSERVER_CONN_STR="Driver={ODBC Driver 18 for SQL Server};..."
# or discrete vars: SEED_SQLSERVER_HOST, _DATABASE, _USER, _PASSWORD
```

<!-- START COPILOT CODING AGENT SUFFIX -->



<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

You are GitHub Copilot Agent Mode working in this repo. Implement a JSON seed-data framework that can TRUNCATE + RESEED our SQL Server dimensional model tables (dims/facts/bridges) in a deterministic, repeatable way.

HIGH-LEVEL GOAL
- Create a framework (folder structure + file formats + loader script + runbook) to load seed JSON into our existing SQL Server tables.
- This PR is about the framework, not about populating large/real datasets. Include only minimal example seed data (a handful of rows) to prove end-to-end.

CONSTRAINTS / ASSUMPTIONS
- Database is SQL Server.
- Tables already exist (see `src/db/ddl/01_dimensions`, `02_facts`, `03_bridges`).
- Tables use an integer surrogate PK called `XxxKey` (IDENTITY) AND a unique GUID column (second ordinal) (e.g., `XxxGuid`), plus SCD-ish flags like `IsActive`, `IsLatest`, timestamps, and a row checksum (names may vary; inspect DDL).
- We will TRUNCATE and fully reload during this seed phase. We are not doing incremental merge/upsert in this PR.
- Foreign key constraints exist; load order matters.
- We do NOT want to check in any copyrighted source content. Seed files must be synthetic and tiny.

DELIVERABLES
1) Folder structure for seeds
- Create: `src/db/seeds/`
  - `src/db/seeds/README.md` (runbook + format spec)
  - `src/db/seeds/schema/` (optional: JSON schema files, if helpful)
  - `src/db/seeds/data/` (the seed JSON files)
  - `src/db/seeds/logs/` (gitignored; runtime logs)
- Add `src/db/seeds/logs/` to `.gitignore` (or equivalent).

2) Seed JSON file format (standardized)
- Define a single consistent JSON envelope per file, something like:
  {
    "seedVersion": "0.1.0",
    "generatedUtc": "2026-01-16T00:00:00Z",
    "target": {
      "schema": "core",
      "table": "DimFranchise",
      "naturalKey": ["UniverseCode", "Name"],   // optional, for documentation
      "loadBehavior": "truncate-insert"
    },
    "options": {
      "allowIdentityInsert": false,             // default
      "ignoreUnknownFields": false,             // default
      "defaults": { "IsActive": true, "IsLatest": true }
    },
    "rows": [
      { "FranchiseGuid": "...", "Name": "...", "UniverseCode": "...", "Notes": "...", "ExtraJson": { ... } },
      ...
    ]
  }
- Keys:
  - `target.schema` + `target.table` must be present.
  - `rows` must be an array of objects where properties map 1:1 to table columns we intend to seed.
  - Do NOT include identity keys in JSON by default (e.g., `FranchiseKey` omitted). We rely on IDENTITY unless `allowIdentityInsert` is explicitly true.
  - Require the GUID column to be provided in seed rows (deterministic ID across reloads). If absent, loader should generate one deterministically ONLY if we define a stable rule (e.g., UUIDv5 based on natural keys). If not implemented, fail with clear error. Prefer implementing deterministic UUID generation.
  - Support an `ExtraJson` / `AttributesJson` column if present; if the table uses NVARCHAR JSON, serialize objects into JSON text.

3) Minimal example seed files
- Create minimal seeds for a working end-to-end load:
  - `DimFranchise`
  - `DimContinuityFrame`
  - `DimEra` and/or `DimEraAnchor` (if used)
  - `DimWork`
  - `DimScene`
  - `DimEntity`
  - `DimSpecies`
  - `DimCharacter`
  - `DimLocation`
  - `DimTechAsset`, `DimTechInstance`, and 1 subtype (e.g., droid model/instance)
  - `DimEventType`
  - `FactEvent`
  - `BridgeEventParticipant`
  - `BridgeEventAsset`
  - `DimIssueType`
  - `ContinuityIssue`
  - `FactClaim`
  - `BridgeContinuityIssueClaim`
- Keep content tiny (1–5 rows per table) but consistent with foreign keys. Use Star Wars-themed synthetic examples (e.g., “Star Wars” franchise; “Canon” frame; “A New Hope” work; “Tatooine” location; “C-3PO” entity/tech instance; one simple event).
- Provide stable GUIDs in the seed rows (hard-coded).

4) Loader implementation
- Add a Python-based loader under `src/ingest/` (or `src/db/seeds/loader/` if you prefer; pick one, but document).
- Suggested path: `src/ingest/seed_loader.py`
- Use `pyodbc` (or `pymssql`) to connect to SQL Server; prefer `pyodbc`.
- Connection config:
  - Use environment variables and/or a local `.env` file (gitignored). Example vars:
    - `SEED_SQLSERVER_CONN_STR` (ODBC connection string) OR discrete vars (server, db, user, pass).
- Loader features:
  - Discover and enforce load order to satisfy FKs. Implement this as a static ordered list in code for now (document it), not dynamic graph inference.
  - For each seed file:
    - Validate envelope + target table.
    - Validate columns exist in target table (query `INFORMATION_SCHEMA.COLUMNS`).
    - Optionally validate GUID column exists and is unique in seed.
    - TRUNCATE behavior:
      - Disable constraints or delete in correct order? Prefer: truncate in reverse dependency order, then insert in dependency order.
      - If TRUNCATE fails due to FK references, fall back to DELETE with `ALTER TABLE ... NOCHECK CONSTRAINT ALL` / `WITH CHECK CHECK CONSTRAINT ALL` a...

</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
