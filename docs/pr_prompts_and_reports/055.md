# PR #55: Add migration 0032: comprehensive schema standardization with data-preserving strategy

## Header

| Field | Value |
|---|---|
| **PR Number** | 55 |
| **Title** | Add migration 0032: comprehensive schema standardization with data-preserving strategy |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/55 |
| **State** | merged |
| **Created** | 2026-02-14T06:18:17Z |
| **Updated** | 2026-02-14T06:33:10Z |
| **Merged** | 2026-02-14T06:33:10Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/update-database-migration-strategies` |
| **Merge commit SHA** | `c5712b454446ceb06eac33f4d86219d2a6524717` |

---

## PR Body

Implements schema standardization migration driven by pre-flight row count inventory. Uses drop/recreate for empty tables, data-preserving copy for tables with data.

## Changes

### Migration Script (`db/migrations/0032_schema_standardization_full.sql`)

- **Migration log table** (`dbo.__migration_log`) - tracks step progress, row counts, status, errors
- **GUID security fix** - cursor-based replacement of `NEWSEQUENTIALID()` → `NEWID()` for all GUID columns
- **DimEvent → DimOccurrence** - table/column/index/FK renames for Phase 6 placeholder
- **Column standardization** - adds `ExternalKey`/`ExternalKeyType` columns, copies from deprecated `ExternalId` variants
- **BridgeEntityRelation** - renames `FromEntityId`/`ToEntityId` → `FromEntityGuid`/`ToEntityGuid` (0-row table)
- **View relocation** - moves `dbo.sem_*` views to `sem.vw_*` with dynamic definition rewrite
- **DateTime analysis** - reports non-compliant columns (DATETIME vs DATETIME2(3), missing Utc suffix)
- **Verification queries** - final validation section with status summary

### Documentation (`docs/db/migration_0032_guide.md`)

- Execution instructions, expected output, rollback procedures, post-migration tasks

## Example: Migration Log Output

```sql
SELECT step_name, status, rows_before, rows_after, duration_ms, notes
FROM dbo.__migration_log
WHERE migration_id = '0032'
ORDER BY log_id;
```

```
step_name                                    status     rows_before  rows_after  duration_ms
-------------------------------------------- ---------- ------------ ----------- -----------
Fix GUID default                             completed  NULL         NULL        45
Rename DimEvent to DimOccurrence             completed  0            0           120
DimEntity ExternalKey column                 skipped    NULL         NULL        2
Move view sem_event → vw_event               completed  NULL         NULL        89
...
```

SQL-only migration. Python reconciliation deferred to subsequent PR.

<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
