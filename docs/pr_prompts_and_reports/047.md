# PR #47: Refine FGA docs: extensible contracts, LLM chunking strategy, best-effort dedupe, temporal examples

## Header

| Field | Value |
|---|---|
| **PR Number** | 47 |
| **Title** | Refine FGA docs: extensible contracts, LLM chunking strategy, best-effort dedupe, temporal examples |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/47 |
| **State** | merged |
| **Created** | 2026-02-13T00:18:54Z |
| **Updated** | 2026-02-13T01:33:08Z |
| **Merged** | 2026-02-13T01:33:08Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/update-fga-documentation` |
| **Merge commit SHA** | `7065a75ff5667bd913fa1ccbb1a9be90871e943d` |

---

## PR Body

Phase 0 FGA docs were overly prescriptive—fixed entity type enums, hard dedupe requirements, vector-centric chunking. Refinement shifts toward extensibility, pragmatic early-phase constraints, and multi-pronged extraction patterns.

## Changes

### Universal Queue Model
- Clarified as **multi-tenant, multi-job-type** backlog supporting concurrent runners processing mixed job types
- Operators bump priorities for batch selection; each job type routes to its own contract/handler

### LLM Contracts: Multi-Pronged Extraction
- Contracts now support **dimensions + facts + bridges + time-scoped assertions** in single extraction
- Entity types open-ended (not limited to Droid/PersonCharacter examples)
- Entities may represent timeframes, events, appearances, facts—not just canonical dimensions

### LLM Context Chunking (Not Vector-Specific)
- Reframed as **general LLM ingestion strategy** with dynamic token budgeting:
  - Available tokens = model window - (system prompt + contract + output buffer + safety margin)
  - Sentence-boundary awareness, overlap for continuity
  - Degrades gracefully for smaller context models
- Vector tables acknowledged but not primary driver in Phase 0-2

### Best-Effort Dedupe
- **Tolerate duplicates** in early phases—exact match + simple fuzzy match (>0.95 similarity)
- Future dedupe audit via LLM contracts mining database
- Downgraded "must merge" language to pragmatic noise tolerance

### Extensible Relationship Taxonomy
- Relationship types stored as **open strings** (not fixed enums): `owned_by`, `visited_in`, `trained_by`, `appeared_in`, `stationed_at`, etc.
- Multiple bridge targets: entity↔entity, entity↔event, entity↔work, entity↔location, entity↔timeline
- Emphasis on **time-scoped assertions** (start/end dates, work context)

### Stored Procedure Dependency Ordering
- Added transactional routing pattern:
  1. Parse JSON to staging tables
  2. Resolve existing IDs (name/natural key lookups)
  3. Insert missing dimensions (capture IDs)
  4. Insert dependent bridges/facts (using resolved IDs)
  5. Commit or rollback (atomic)
- Python handles validation + artifact logging; SQL handles routing + dependency resolution

### Observability: Artifact-First
- Removed Prometheus implementation details from Phase 0-3 (deferred to post-Phase 3)
- Focus: structured JSON logs, correlation IDs, per-run artifacts (inputs, outputs, errors)

### Temporal Examples
Two examples demonstrating multi-output extraction with time awareness:

**Example A: Dagobah (location-centric)**
```json
{
  "dimensions": [
    {"type": "Location", "name": "Dagobah", ...},
    {"type": "PersonCharacter", "name": "Yoda", ...},
    {"type": "PersonCharacter", "name": "Luke Skywalker", ...}
  ],
  "relationships": [
    {
      "from_entity": "Yoda",
      "to_entity": "Dagobah",
      "relation_type": "resided_in",
      "start_date": "19 BBY",
      "end_date": "4 ABY",
      "work_context": ["Revenge of the Sith", "Empire Strikes Back", "Return of the Jedi"]
    }
  ]
}
```

**Example B: R2-D2 ownership (temporal)**
- Demonstrates ownership changes across 7 time periods (Naboo → Padmé → Bail → Raymus → Leia → Luke)
- Different relationship types: `owned_by`, `assigned_to`, `entrusted_to`
- Highlights that "R2-D2 owned_by Luke" is incomplete without timeframe

## Files Modified
- `docs/fga/04-functional-gap-analysis.md` (~800 lines refined)
- `docs/fga/05-recommendations-and-next-steps.md` (~160 lines refined, examples added)
- `docs/fga/README.md` (descriptions updated, changelog entry)

Documentation-only changes—no code, migrations, or runtime modules.

<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
