# PR #42: Expand page classification taxonomy and add WorkMedia metadata layer

## Header

| Field | Value |
|---|---|
| **PR Number** | 42 |
| **Title** | Expand page classification taxonomy and add WorkMedia metadata layer |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/42 |
| **State** | merged |
| **Created** | 2026-02-08T04:40:15Z |
| **Updated** | 2026-02-08T05:33:26Z |
| **Merged** | 2026-02-08T05:33:25Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/expand-primarytype-taxonomy` |
| **Merge commit SHA** | `b0a32f3e2382334883b92ae5d40063fc2e54f563` |

---

## PR Body

Material number of pages classified as `Unknown` due to taxonomy gaps (vehicles, items, droids) and missing category for meta/reference pages. WorkMedia needed second-layer metadata for medium type and canon context.

## Taxonomy Expansion (v1.0 â†’ v1.1)

**New types:**
- `Droid` - Disambiguates named droids and droid models from PersonCharacter/ObjectArtifact
- `VehicleCraft` - Starships, starfighters, craft with technical specs
- `ObjectItem` - Weapons, gear, armor, apparel (handheld/worn items)
- `ReferenceMeta` - Lists, timelines, disambiguation pages (renamed from MetaReference)

**Consolidation:**
- `Other` â†’ `Unknown` (clarity)
- `ObjectArtifact` retained for backward compatibility
- Old unused types removed: Technology, Vehicle, Weapon

## WorkMedia Metadata

Added conditional fields to `sem.PageClassification`:
```python
work_medium: Optional[WorkMedium] = None  # film|tv|game|book|comic|reference|episode|short|other|unknown
canon_context: Optional[CanonContext] = None  # canon|legends|both|unknown
```

Populated only when `primary_type == "WorkMedia"`. Schema enforces null otherwise.

## Decision Rubric

Replaced enum list with 14-step priority order:
1. ReferenceMeta (lists/timelines/disambiguation)
2. VehicleCraft (craft with specs)
3. ObjectItem (physical items/gear)
4. Droid (named droids/models)
5. PersonCharacter (sentient individuals with biography)
...

Each type includes:
- Concise definition (1-2 sentences)
- Strong cues
- Examples (Canon + Legends)
- Explicit exclusions

## Migration

`db/migrations/0022_expand_page_classification_taxonomy.sql`:
- Adds `work_medium` and `canon_context` columns with CHECK constraints
- Indexes on new columns for filtering
- Idempotent, no data migration required

## Files Changed

- `src/semantic/models.py` - PageType/WorkMedium/CanonContext enums
- `src/llm/contracts/page_classification_v1_schema.json` - Updated schema
- `src/llm/prompts/page_classification.py` - Enhanced system prompt with rubric
- `src/llm/interrogations/definitions/page_classification.py` - Updated TYPE KEY
- `src/sem_staging/dry_run_page_classification.py` - Output schema
- `db/migrations/0022_expand_page_classification_taxonomy.sql` - New migration
- Tests updated, all passing (50/50)
- `docs/page-classification-taxonomy-v1.1.md` - Comprehensive reference

## Example Classification

```python
# Droid classification
{
  "primary_type": "Droid",
  "confidence": 0.95,
  "rationale": "R2-D2 is a named astromech droid"
}

# WorkMedia with metadata
{
  "primary_type": "WorkMedia",
  "work_medium": "film",
  "canon_context": "canon",
  "confidence": 0.98,
  "rationale": "The Mandalorian is a Disney+ series in Canon timeline"
}
```

No breaking changes. Backward compatible.

<!-- START COPILOT CODING AGENT SUFFIX -->



<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

# Copilot Agent Task â€” Expand PrimaryType taxonomy + strengthen Ollama prompt rubric + (if needed) add 2nd-layer work metadata + SQL migrations

## Context
We have a semantic staging classification step where Ollama returns a structured JSON response. A material number of pages are being classified as `PrimaryType = "Unknown"`. This is happening for two broad reasons:
1) legitimate â€œmeta/reference/list/disambiguationâ€ pages that donâ€™t fit our current buckets
2) taxonomy gaps (vehicles, items/gear, droids/tech) causing the model to default to Unknown

Current PrimaryType enum values:
- `Concept`
- `EventConflict`
- `LocationPlace`
- `Organization`
- `PersonCharacter`
- `Species`
- `WorkMedia`
- `Unknown`

We want to **extend our existing patterns** (without breaking compatibility), and also **update the Ollama prompt** so it doesnâ€™t just list allowed values, but includes a clear rubric describing *how to choose*, with examples.

Additionally, there is a â€œsecond layerâ€ concept for WorkMedia (e.g., film/tv/game/book; canon vs legends). We may already have it â€” prefer using existing schema. If it does not exist, create it and include SQL migrations.

## Goals
1) Add new PrimaryType categories to reduce Unknowns:
   - `VehicleCraft`
   - `ObjectItem`
   - `ReferenceMeta`
   - optionally `Droid` (high yield)
   - optionally `TechnologySystem` (if it aligns with existing patterns)
2) Update the Ollama JSON schema / allowed values accordingly.
3) Update the prompt to include a **selection rubric**:
   - decision rules
   - tie-breakers
   - examples (canonical + legends)
   - explicit guidance for list/timeline/disambiguation/reference pages
4) If a second-layer WorkMedia metadata layer exists, reuse it; otherwise add it:
   - `work_medium` (film|tv|game|book|comic|reference|episode|short|other)
   - `canon_context` (canon|legends|both|unknown)
5) Add SQL migrations/scripts if schema changes are required.
6) Keep changes aligned with current code patterns and naming conventions.

---

## Step 1 â€” Locate current implementation + schema
Please search the repo and identify:
- Where the PrimaryType enum/list is defined (Python constants, JSON schema, docs, SQL table constraints, etc.)
- Where the Ollama prompt template lives for page classification
- Where we validate/parsing the returned JSON schema
- Where classification results are persisted (tables/columns; look at `sem.PageClassification` / similar)
- Whether a second-layer WorkMedia column(s) already exist (e.g., `work_medium`, `canon_context`, `media_type`, etc.)

Output a short map of:
- file paths + relevant symbols
- SQL tables + columns involved

---

## Step 2 â€” Extend PrimaryType taxonomy (minimal, high value)
Add new PrimaryType values using existing patterns:

### New values (required)
- `VehicleCraft`  
  For starships, starfighters, shuttles, freighters, battle stations, vehicles with specs/armament/class/manufacturer.
- `ObjectItem`  
  For weapons, lightsabers, blasters, armor, helmets, clothing, insignia, gear, â€œwardrobeâ€, tattoos, etc.
- `ReferenceMeta`  
  For list/index/timeline/disambiguation/guide/reference pages, encyclopedias, home-video-release lists, â€œcontent cut fromâ€¦â€, etc.

### New value (optional, but recommended if consistent with model)
- `Droid`  
  For droids as entities or model lines; reduces ambiguity vs `PersonCharacter` vs `Species`.

### New value (optional)
- `TechnologySystem`  
  For system-level or technical concept pages not best represented as ObjectItem/VehicleCraft.

If you choose to NOT add an optional value, document the fallback rules (e.g., droid models => Concept; named droids => PersonCharacter).

---

## Step 3 â€” Update the Ollama prompt rubric (critical)
Update the page-classification prompt so it includes:
1) **Allowed PrimaryType values** (including the new ones)
2) **Definitions** (1â€“2 sentences each)
3) **Decision rubric / tie-breakers** in order:
   - If it is clearly list/timeline/disambiguation/reference â†’ `ReferenceMeta`
   - If it is a single craft/vehicle/station with specs/class/manufacturer â†’ `VehicleCraft`
   - If it is a physical object/gear/weapon/apparel â†’ `ObjectItem`
   - If it is a named living/acting character/persona â†’ `PersonCharacter`
   - If it is an organization/faction/government/company â†’ `Organization`
   - If it is a planet/base/region/structure/place â†’ `LocationPlace`
   - If it is a species/type of creature/race â†’ `Species`
   - If it is a film/tv episode/game/book/comic/media title â†’ `WorkMedia`
   - If it is an abstract idea/role/rank/concept/discipline â†’ `Concept`
   - Only return `Unknown` if it genuinely does not fit any category (rare)
4) **Examples** (at least 2 per new category), including Legends cases.
5) Require the model to return:
   - `primary_type` (one of enum)
   - `confidence` (0â€“1)
   - `rationale` (short)
   - optionally `secondary_tags` (small array) if our schema supports it

Keep the response JSON strictly valid and aligned with our existing schema (do no...

</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

ðŸ’¬ We'd love your input! Share your thoughts on Copilot coding agent in our [2 minute survey](https://gh.io/copilot-coding-agent-survey).

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
