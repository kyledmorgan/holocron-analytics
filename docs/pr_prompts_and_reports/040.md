# PR #40: [WIP] Add DimEntity upsert functionality for SEM classification

## Header

| Field | Value |
|---|---|
| **PR Number** | 40 |
| **Title** | [WIP] Add DimEntity upsert functionality for SEM classification |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/40 |
| **State** | closed |
| **Created** | 2026-02-07T05:46:29Z |
| **Updated** | 2026-02-10T16:46:54Z |
| **Merged** | _N/A_ |
| **Base branch** | `main` |
| **Head branch** | `copilot/upsert-dimentity-records` |
| **Merge commit SHA** | `152cb9b01ef3a5484ce53ec2b19b1c036bd2f95b` |

---

## PR Body

Thanks for asking me to work on this. I will get started on it and keep this PR's description up to date as I form a plan and make progress.


<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

> > ## Additive Requirement: DimEntity Upsert (Create-or-Update) When No Match Exists
> >
> > ### Intent
> > During SEM classification runs, the pipeline must ensure a corresponding `dbo.DimEntity` record exists for the inferred/target entity title. If a matching DimEntity row does not exist, create it using the established DimEntity patterns. If it does exist, update it with the latest “promotion / candidacy” metadata and any new semantic fields produced by the run.
> >
> > ### Match / Identity Rule
> > Use a deterministic “same word” match to locate an existing DimEntity row:
> > - Prefer matching on a **normalized** version of the entity display name (e.g., case-insensitive, trimmed, collapsed whitespace).
> > - If the model/schema already has a canonical key column (e.g., `entity_name`, `entity_title`, `entity_slug`, `entity_key`), use the existing canonical pattern.
> > - If we already store source identity (e.g., `sem.SourcePage.page_id` / `resource_id`), we may also match on that as a secondary/stronger match when present.
> >
> > ### Upsert Behavior
> > 1) **Lookup** existing `DimEntity` using the “same word” match rule.
> > 2) If found:
> >    - **UPDATE** the entity with any new classifier outputs that are part of the feature set:
> >      - candidacy / promotion state columns (e.g., `candidate_state`, `is_candidate`, `adjudication_status`, timestamps)
> >      - inferred type(s), confidence, lead sentence summary (50 words max), review flag
> >      - any lightweight provenance pointers (e.g., `source_page_id`, `resource_id`) if that’s the chosen linkage
> > 3) If not found:
> >    - **INSERT** a new DimEntity row fully populated with:
> >      - normalized name + display name
> >      - initial candidacy/promotion state (default: “Candidate/NeedsReview” unless confidence threshold is met)
> >      - created timestamps / created-by markers per existing conventions
> >      - link back to `sem.SourcePage` (or ingest resource identity) if available
> > 4) Return the `dim_entity_id` (or whatever the PK is) for downstream inserts into:
> >    - `sem.PageClassification` (and/or) `sem.PageSignals`
> >    - tag assignment bridges (`dbo.BridgeTagAssignment`)
> >
> > ### Idempotency
> > Running the same title through the pipeline repeatedly must not create duplicates.
> > - Ensure the match rule is stable.
> > - Prefer a unique constraint on the normalized title/key if it exists (or add one if consistent with current patterns).
> >
> > ### Implementation Guidance (SQL Server)
> > - Use a single atomic upsert pattern:
> >   - `MERGE` (careful with known caveats) **or**
> >   - `UPDATE ...; IF @@ROWCOUNT=0 INSERT ...;` inside a transaction
> > - Always capture the resulting PK (`OUTPUT inserted.<pk>` or `SCOPE_IDENTITY()` where appropriate).
> >
> > ### Notes
> > - Keep this “DimEntity upsert” step inside the SEM run so classification, signals, and tags always have a valid entity FK to attach to.
> > - Do not broaden scope beyond the saved migrations and current feature set; just ensure DimEntity exists and is updated/created as needed.


</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
