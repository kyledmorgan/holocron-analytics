# PR #60: LLM provenance + lineage schema extensions

## Header

| Field | Value |
|---|---|
| **PR Number** | 60 |
| **Title** | LLM provenance + lineage schema extensions |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/60 |
| **State** | merged |
| **Created** | 2026-02-21T00:43:59Z |
| **Updated** | 2026-02-21T03:39:40Z |
| **Merged** | 2026-02-21T03:39:40Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/add-llm-provenance-lineage` |
| **Merge commit SHA** | `ada63ee3d0fa7235867f77e3a8a8a8cf5fcba3f1` |

---

## PR Body

Implements two-layer provenance tracking: **extractor provenance** (which Ollama run/model/prompt produced output) and **evidence provenance** (which real-world sources were in the curated input bundle). Enables end-to-end lineage from source evidence → LLM run → artifacts → DVO records.

### Schema: LLM tables (migration 0033)

- **`llm.run`** — first-class artifact FKs (`request_artifact_id`, `response_artifact_id`, `output_artifact_id`, `prompt_rendered_artifact_id`), prompt metadata (`prompt_template_ref`, `prompt_template_version`, `prompt_hash`), run chaining (`parent_run_id`), dedupe (`run_fingerprint`)
- **`llm.artifact`** — `content_mime_type`, `schema_version`, expanded `artifact_type` CHECK with 8 new types (`prompt_rendered`, `llm_request`, `merge_payload`, etc.)
- **`llm.evidence_item`** — `source_system`, `source_uri`, `source_ref`, `selector_json`, `ordinal`, `role`, `excerpt_hash`, `created_utc`
- **`llm.evidence_bundle`** — `bundle_sha256`, `bundle_kind`, `created_by`, `notes`, `assembly_artifact_id`
- **`llm.run_evidence`** — `role`, `attached_by`, `attached_reason`
- **`llm.job`** — `input_bundle_id` (FK), `prompt_template_ref/version`, `contract_version`, `requested_output_types`, `job_fingerprint`

### Schema: DVO linkage (migration 0034)

Adds nullable `EvidenceBundleGuid UNIQUEIDENTIFIER NULL` with filtered indexes to all 7 DVO fact/bridge tables (`FactEvent`, `FactClaim`, `ContinuityIssue`, `BridgeEventParticipant`, `BridgeEventAsset`, `BridgeContinuityIssueClaim`, `BridgeEntityRelation`). Uses `...Guid` suffix per naming conventions — not `...Id`.

### Python contracts

```python
# EvidenceItem gains provenance fields
item = EvidenceItem(
    ...,
    source_system="wookieepedia",
    source_uri="https://starwars.fandom.com/wiki/Sebulba",
    selector_json={"paragraph_ids": [3, 4, 5]},
    ordinal=0,
    role="primary",
)

# EvidenceBundle gains deterministic fingerprinting
bundle = EvidenceBundle(items=items, bundle_kind="llm_input", created_by="worker-01")
bundle.compute_bundle_hash()  # SHA256 of ordered item content hashes
```

All new fields are optional (`None` default) for backward compatibility. `compute_bundle_hash()` raises `ValueError` if any item lacks `content_sha256`.

### Documentation

`docs/llm/lineage.md` upgraded from Phase 7 placeholder to full schema reference with lineage graph, traceability query patterns, and column inventory.

### Tests

17 new unit tests covering provenance field serialization/deserialization, bundle hash determinism, order sensitivity, error handling, and JSON roundtrip with backward compatibility. 39 total, all passing.

<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
