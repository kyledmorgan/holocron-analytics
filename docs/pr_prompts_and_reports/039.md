# PR #39: Add DimEntity upsert for SEM classification pipeline

## Header

| Field | Value |
|---|---|
| **PR Number** | 39 |
| **Title** | Add DimEntity upsert for SEM classification pipeline |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/39 |
| **State** | merged |
| **Created** | 2026-02-07T05:40:15Z |
| **Updated** | 2026-02-07T05:49:22Z |
| **Merged** | 2026-02-07T05:49:22Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/upsert-dimentity-record` |
| **Merge commit SHA** | `510beff58c0566068d7bdb2891e81cf18991b02c` |

---

## PR Body

During SEM classification runs, the pipeline must ensure a corresponding `dbo.DimEntity` record exists for each classified entity. Previously, the pipeline only updated existing entities and failed silently when no match was found.

## Changes

### `SemanticStagingStore.upsert_dim_entity()`
- **Match rule**: Normalized display name (lowercase, trimmed, collapsed whitespace → underscore)
- **On match**: UPDATE with PromotionState, PrimaryTypeInferred, TypeSetJsonInferred, SourcePageId
- **On no match**: INSERT new entity with candidate/staged state based on confidence threshold (≥0.80 → candidate)
- Returns `{success, entity_key, entity_guid, action, error}` for downstream FK usage

### Integration
- `dry_run_page_classification.py` now uses store's upsert method
- Tracks/displays action (inserted vs updated) in output
- Old `update_dim_entity()` deprecated

### Tests
- 18 unit tests covering normalization, update/insert paths, promotion state logic, idempotency

```python
result = store.upsert_dim_entity(
    title="Luke Skywalker",
    source_page_id="abc-123",
    primary_type="PersonCharacter",
    confidence=0.95,
)
# result: {"success": True, "entity_key": 456, "action": "inserted", ...}
```

<!-- START COPILOT CODING AGENT SUFFIX -->



<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

> > ## Additive Requirement: DimEntity Upsert (Create-or-Update) When No Match Exists
> >
> > ### Intent
> > During SEM classification runs, the pipeline must ensure a corresponding `dbo.DimEntity` record exists for the inferred/target entity title. If a matching DimEntity row does not exist, create it using the established DimEntity patterns. If it does exist, update it with the latest “promotion / candidacy” metadata and any new semantic fields produced by the run.
> >
> > ### Match / Identity Rule
> > Use a deterministic “same word” match to locate an existing DimEntity row:
> > - Prefer matching on a **normalized** version of the entity display name (e.g., case-insensitive, trimmed, collapsed whitespace).
> > - If the model/schema already has a canonical key column (e.g., `entity_name`, `entity_title`, `entity_slug`, `entity_key`), use the existing canonical pattern.
> > - If we already store source identity (e.g., `sem.SourcePage.page_id` / `resource_id`), we may also match on that as a secondary/stronger match when present.
> >
> > ### Upsert Behavior
> > 1) **Lookup** existing `DimEntity` using the “same word” match rule.
> > 2) If found:
> >    - **UPDATE** the entity with any new classifier outputs that are part of the feature set:
> >      - candidacy / promotion state columns (e.g., `candidate_state`, `is_candidate`, `adjudication_status`, timestamps)
> >      - inferred type(s), confidence, lead sentence summary (50 words max), review flag
> >      - any lightweight provenance pointers (e.g., `source_page_id`, `resource_id`) if that’s the chosen linkage
> > 3) If not found:
> >    - **INSERT** a new DimEntity row fully populated with:
> >      - normalized name + display name
> >      - initial candidacy/promotion state (default: “Candidate/NeedsReview” unless confidence threshold is met)
> >      - created timestamps / created-by markers per existing conventions
> >      - link back to `sem.SourcePage` (or ingest resource identity) if available
> > 4) Return the `dim_entity_id` (or whatever the PK is) for downstream inserts into:
> >    - `sem.PageClassification` (and/or) `sem.PageSignals`
> >    - tag assignment bridges (`dbo.BridgeTagAssignment`)
> >
> > ### Idempotency
> > Running the same title through the pipeline repeatedly must not create duplicates.
> > - Ensure the match rule is stable.
> > - Prefer a unique constraint on the normalized title/key if it exists (or add one if consistent with current patterns).
> >
> > ### Implementation Guidance (SQL Server)
> > - Use a single atomic upsert pattern:
> >   - `MERGE` (careful with known caveats) **or**
> >   - `UPDATE ...; IF @@ROWCOUNT=0 INSERT ...;` inside a transaction
> > - Always capture the resulting PK (`OUTPUT inserted.<pk>` or `SCOPE_IDENTITY()` where appropriate).
> >
> > ### Notes
> > - Keep this “DimEntity upsert” step inside the SEM run so classification, signals, and tags always have a valid entity FK to attach to.
> > - Do not broaden scope beyond the saved migrations and current feature set; just ensure DimEntity exists and is updated/created as needed.


</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
