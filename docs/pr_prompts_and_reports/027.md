# PR #27: [WIP] Consolidate ingest tables into Holocron and remove HolocronAnalytics

## Header

| Field | Value |
|---|---|
| **PR Number** | 27 |
| **Title** | [WIP] Consolidate ingest tables into Holocron and remove HolocronAnalytics |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/27 |
| **State** | closed |
| **Created** | 2026-01-24T05:33:53Z |
| **Updated** | 2026-01-24T05:41:31Z |
| **Merged** | _N/A_ |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/consolidate-ingest-tables` |
| **Merge commit SHA** | `30353d98e86e8309ed5c95ac9970a4b46068da8d` |

---

## PR Body

Thanks for asking me to work on this. I will get started on it and keep this PR's description up to date as I form a plan and make progress.


<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

> [!IMPORTANT]
> # PR Request (Copilot Agent) — Consolidate `ingest.*` into `Holocron`; Remove `HolocronAnalytics`; Add Guardrails
>
> ## Context / Problem Statement
> We currently have **two databases** in the same SQL Server instance:
> - `Holocron` (intended **system-of-record**; contains the primary dbo.* star-schema objects)
> - `HolocronAnalytics` (an **unintended artifact**; contains several `ingest.*` tables)
>
> This split is accidental and likely originated from prior agent-generated instructions that used the wrong database name (`HolocronAnalytics`).  
> We need to **migrate** all `ingest` schema objects (and their data) from `HolocronAnalytics` into `Holocron`, then drop `HolocronAnalytics`, and prevent recurrence with explicit agent guardrails.
>
> **System-of-record database name is explicitly: `Holocron`**.
>
> ---
>
> # Acceptance Criteria
> 1) All `ingest.*` objects that currently exist in `HolocronAnalytics` are present in `Holocron` with the correct schema and all data.
> 2) Any repo code/config/docs that reference `HolocronAnalytics` are updated to reference `Holocron` (or parameterized so the default is Holocron).
> 3) `HolocronAnalytics` is dropped (or we provide an explicit final step script, if it cannot be executed automatically).
> 4) Add **agent rule(s)** and documentation to explicitly prevent “alternate database name drift” going forward.
> 5) Add an automated **repo scan** check that fails if the forbidden database name `HolocronAnalytics` appears anywhere in tracked files.
>
> ---
>
> # Scope (This PR)
>
> ## 1) Database migration scripts (SQL Server)
> Create a migration script (follow repo’s existing migrations convention) that:
> - Ensures the `ingest` schema exists in `Holocron`
> - Creates the missing `ingest.*` tables in `Holocron` (schema-first)
> - Copies data from `HolocronAnalytics.ingest.*` → `Holocron.ingest.*` (identity-safe)
> - Includes verification queries (row counts) to confirm parity
>
> ### 1.1 Inventory script (must be included)
> Add a SQL script section that lists all objects under `ingest` schema in `HolocronAnalytics` so we know exactly what we are migrating:
>
> ```sql
> SELECT 
>   o.type_desc,
>   QUOTENAME(s.name) + '.' + QUOTENAME(o.name) AS object_name
> FROM HolocronAnalytics.sys.objects o
> JOIN HolocronAnalytics.sys.schemas s ON s.schema_id = o.schema_id
> WHERE s.name = 'ingest'
>   AND o.is_ms_shipped = 0
> ORDER BY o.type_desc, object_name;
> ```
>
> Use this output to drive the final list of objects to migrate (tables, and any views/procs if they exist).
>
> ### 1.2 Schema creation approach (recommended)
> Prefer “schema-only” object generation into `Holocron` using SSMS “Generate Scripts” patterns, then place the resulting DDL into repo migrations:
> - Script table definitions + constraints + indexes
> - Modify the script to `USE [Holocron]`
> - Ensure the objects are created under `[ingest].[…]`
>
> Ensure `CREATE SCHEMA [ingest]` is present (or guarded).
>
> ### 1.3 Safety requirement for existing tables
> If a target table already exists in `Holocron` (especially `ingest.IngestRecords`, which appears in both DBs):
> - First compare schema between source and target (column/types/nullable/identity)
> - If schemas differ, rename the existing target table to a backup name before recreating from source schema
>
> Include a schema comparison utility query for at least `IngestRecords` (and reuse for others if needed):
>
> ```sql
> ;WITH src AS (
>   SELECT c.name, c.column_id, t.name AS type_name, c.max_length, c.precision, c.scale, c.is_nullable, c.is_identity
>   FROM HolocronAnalytics.sys.columns c
>   JOIN HolocronAnalytics.sys.types t ON c.user_type_id = t.user_type_id
>   WHERE c.object_id = OBJECT_ID('HolocronAnalytics.ingest.IngestRecords')
> ),
> tgt AS (
>   SELECT c.name, c.column_id, t.name AS type_name, c.max_length, c.precision, c.scale, c.is_nullable, c.is_identity
>   FROM Holocron.sys.columns c
>   JOIN Holocron.sys.types t ON c.user_type_id = t.user_type_id
>   WHERE c.object_id = OBJECT_ID('Holocron.ingest.IngestRecords')
> )
> SELECT
>   COALESCE(src.name, tgt.name) AS column_name,
>   src.type_name AS src_type, tgt.type_name AS tgt_type,
>   src.max_length AS src_len, tgt.max_length AS tgt_len,
>   src.is_nullable AS src_null, tgt.is_nullable AS tgt_null,
>   src.is_identity AS src_ident, tgt.is_identity AS tgt_ident
> FROM src
> FULL OUTER JOIN tgt ON src.name = tgt.name
> ORDER BY column_name;
> ```
>
> If needed, rename the existing target table before recreate/copy:
> ```sql
> USE [Holocron];
> EXEC sp_rename 'ingest.IngestRecords', 'IngestRecords__bak_20260123';
> ```
>
> ### 1.4 Data copy strategy (identity-safe, generic)
> Implement a copy routine that:
> - builds a deterministic column list
> - turns `IDENTITY_INSERT` on/off when needed
> - inserts from source DB to target DB
>
> Provide a “table list” section for known Phase-0 ingest tables (update list as inventory confirms):
> - `ingest.ingest_runs`
> - `in...

</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

✨ Let Copilot coding agent [set things up for you](https://github.com/kyledmorgan/holocron-analytics/issues/new?title=✨+Set+up+Copilot+instructions&body=Configure%20instructions%20for%20this%20repository%20as%20documented%20in%20%5BBest%20practices%20for%20Copilot%20coding%20agent%20in%20your%20repository%5D%28https://gh.io/copilot-coding-agent-tips%29%2E%0A%0A%3COnboard%20this%20repo%3E&assignees=copilot) — coding agent works faster and does higher quality work when set up for your repo.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
