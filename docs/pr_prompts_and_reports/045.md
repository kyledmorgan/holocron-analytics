# PR #45: Phase 2: Schema refactor cutover ‚Äî vector schema is now sole home for embeddings

## Header

| Field | Value |
|---|---|
| **PR Number** | 45 |
| **Title** | Phase 2: Schema refactor cutover ‚Äî vector schema is now sole home for embeddings |
| **URL** | https://github.com/kyledmorgan/holocron-analytics/pull/45 |
| **State** | merged |
| **Created** | 2026-02-10T05:45:06Z |
| **Updated** | 2026-02-10T06:31:36Z |
| **Merged** | 2026-02-10T06:31:36Z |
| **Base branch** | `working_20260115` |
| **Head branch** | `copilot/cutover-and-cleanup-phase-2` |
| **Merge commit SHA** | `dbf991c6ccf3bbaa148445301ad2b7ad04dfcd66` |

---

## PR Body

Completes the `llm` ‚Üí `vector` schema split. The `vector` schema is now the exclusive home for chunking, embeddings, and retrieval. Legacy tables renamed to `*_legacy` for archival.

## Database

- **Migration 0024**: Renames legacy vector tables in `llm` schema:
  - `llm.chunk` ‚Üí `llm.chunk_legacy`
  - `llm.embedding` ‚Üí `llm.embedding_legacy`  
  - `llm.retrieval` ‚Üí `llm.retrieval_legacy`
  - `llm.retrieval_hit` ‚Üí `llm.retrieval_hit_legacy`
  - `llm.source_registry` ‚Üí `llm.source_registry_legacy`
- Chat runtime tables (`llm.job`, `llm.run`, `llm.artifact`, evidence tables) unchanged

## Python

- `Indexer` now uses `VectorStore` exclusively for persistence
- `RetrievalStore` deprecated with runtime warning:

```python
# New (recommended)
from src.vector.store import VectorStore
store = VectorStore(connection=conn)

# Legacy (raises DeprecationWarning)
from src.llm.retrieval.search import RetrievalStore
store = RetrievalStore(connection=conn)
```

## Documentation

- Migration notes, status.md, vector README updated to reflect Phase 2 completion
- Legacy retrieval.md marked as historical reference

## Verification

- 282 tests pass (34 vector + 248 llm)
- CodeQL: no alerts

<!-- START COPILOT CODING AGENT SUFFIX -->



<!-- START COPILOT ORIGINAL PROMPT -->



<details>

<summary>Original prompt</summary>

# Phase 2 ‚Äî Cutover + Cleanup (Feature Complete End-State) ‚Äî DESCRIPTIVE, NOT PRESCRIPTIVE

> **Important for Agent Mode:**  
> This phase description is **explicit about what must exist by the end**, but it remains **descriptive** rather than a literal script.  
> You (the agent) should determine exact literals (names, file paths, migration numbers, module names) by inspecting the repo and prior PR artifacts.  
> Phase 2 is intended to be **feature-complete** across the Phase 0 ‚Üí Phase 1 ‚Üí Phase 2 roadmap.

---

## Where We Are Now (Post Phase 1 Summary)
Phase 1 successfully introduced a parallel vector runtime:

### Confirmed Phase 0 foundation (already complete)
- Legacy schema snapshot exists and documents:
  - `llm.chunk`, `llm.embedding`, `llm.retrieval`, `llm.retrieval_hit`, `llm.source_registry`
  - Purpose + deprecation rationale + replacements
- Dependency inventory exists and confirms:
  - No SQL procs/views depend on legacy vector tables
  - Python references to legacy vector subsystem were isolated/experimental
  - Chat runtime has zero vector dependencies
- Migration notes exist and were updated as Phase 1 progressed

### Confirmed Phase 1 implementation (just completed)
**Database**
- New migration created `vector` schema with core tables (8 total):
  - `vector.embedding_space`
  - `vector.job`, `vector.run`
  - `vector.source_registry`
  - `vector.chunk`
  - `vector.embedding` (idempotent via `(chunk_id, embedding_space_id, input_content_sha256)`)
  - `vector.retrieval`, `vector.retrieval_hit`

**Python**
- New `src/vector/` package with:
  - `VectorStore` (DB access patterns)
  - Contracts for `EmbeddingSpace`, `VectorChunk`, `VectorEmbedding`
- Legacy `RetrievalStore` still unchanged (explicitly noted as legacy)

**Documentation**
- Migration notes updated to mark Phase 1 complete
- New `docs/vector/README.md` added
- Original prompt retained

### Implication
We have the vector runtime *standing up in parallel* and can now proceed to the final cutover.

---

## Phase 2 Goal (Feature Complete End-State)
**By the end of Phase 2, the refactor is complete:**
- `llm` schema is **chat runtime only**
- `vector` schema is the **sole** home for:
  - chunking for retrieval/embedding
  - embedding generation/storage
  - retrieval logging / hits
  - indexing state
  - vector job/run orchestration
- All code and documentation references align to the new split.
- Legacy vector tables in `llm` are removed or clearly deprecated and unreachable from active codepaths.

Phase 2 is where we stop being ‚Äúparallel‚Äù and become ‚Äúmigrated.‚Äù

---

## Phase 2 Deliverables (Explicit, End-to-End)

### 1) Code Cutover: All Vector Operations Use `vector.*` Exclusively
**Intent:** No active runtime code should read/write legacy vector tables under `llm`.

**What must be true by end of Phase 2**
- Any embedding generation or storage uses:
  - `vector.embedding_space`, `vector.embedding`
- Any retrieval query logging uses:
  - `vector.retrieval`, `vector.retrieval_hit`
- Any indexing/chunk refresh logic uses:
  - `vector.source_registry`, `vector.chunk`
- Any vector job orchestration uses:
  - `vector.job`, `vector.run`

**Agent guidance**
- Use the Phase 0 dependency inventory and Phase 1 additions as the starting map.
- Expect that the remaining work is primarily:
  - refactoring or retiring the legacy `src/llm/retrieval/` modules
  - routing any experimental retrieval tests to `src/vector/` equivalents
- It is acceptable (and expected) to remove or rewrite experimental vector code paths if they are not stable.

---

### 2) Remove / Deprecate Legacy Vector Subsystem from `llm`
**Intent:** `llm` should not contain embedding/retrieval/indexing tables.

**What must be true by end of Phase 2**
- Legacy tables are no longer used:
  - `llm.source_registry`
  - `llm.chunk`
  - `llm.embedding`
  - `llm.retrieval`
  - `llm.retrieval_hit`

**Removal approach is agent‚Äôs choice**
- Drop them outright (preferred if safe and confirmed unused), OR
- Rename to an archival naming convention (`*_legacy`) and block access, OR
- Move to an archival schema (only if that supports governance needs)

**Guardrail**
- The Phase 0 legacy snapshot file remains as the canonical ‚Äúhistory artifact,‚Äù regardless of what is dropped.

---

### 3) Confirm Chat Runtime Non-Regression (Must Not Break)
**Intent:** The chat pipeline remains operational and unaffected.

**What must be true by end of Phase 2**
- `llm.job`, `llm.run`, evidence tables, and artifacts remain intact:
  - `llm.job`
  - `llm.run`
  - `llm.artifact`
  - `llm.evidence_bundle`
  - `llm.evidence_item`
  - `llm.run_evidence`
- No changes that require updates to the existing chat worker(s) unless they are clearly backward compatible.
- The chat workflow continues to produce runs and artifacts as before.

**Agent guidance**
- Since Phase 0 proved no vector dependencies in chat runtime, this should remain low-risk.
- Still, validate with a smoke run or existing test harness if present.

---
...

</details>



<!-- START COPILOT CODING AGENT TIPS -->
---

üí° You can make Copilot smarter by setting up custom instructions, customizing its development environment and configuring Model Context Protocol (MCP) servers. Learn more [Copilot coding agent tips](https://gh.io/copilot-coding-agent-tips) in the docs.

---

## Comments

_No comments._

---

## Review Comments (inline diff)

_No inline review comments._

---

## Copilot Artifacts

_No Copilot artifact indicators detected._
